name: Smart Contract Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'contracts/**'
      - '.github/workflows/contract-tests.yml'
  pull_request:
    branches: [main]
    paths:
      - 'contracts/**'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build-and-test:
    name: Build & Integration Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
          components: clippy, rustfmt

      - name: Cache Cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            contracts/near_splitter
            contracts/ft_mock
            contracts/integration-tests
          # Don't cache to avoid stale dependency issues
          cache-on-failure: false

      - name: Install binaryen (wasm-opt)
        run: |
          # Ubuntu 22.04 ships binaryen 105 which is too old for --signext-lowering (added in v111)
          # Install a recent version from GitHub releases
          BINARYEN_VERSION=119
          curl -L "https://github.com/WebAssembly/binaryen/releases/download/version_${BINARYEN_VERSION}/binaryen-version_${BINARYEN_VERSION}-x86_64-linux.tar.gz" -o binaryen.tar.gz
          tar -xzf binaryen.tar.gz
          sudo cp binaryen-version_${BINARYEN_VERSION}/bin/* /usr/local/bin/
          wasm-opt --version

      - name: Pin compatible dependencies
        run: |
          # Generate lock files first, then pin problematic crates
          cd contracts/near_splitter
          cargo generate-lockfile
          cargo update home --precise 0.5.9 || true
          cargo update time --precise 0.3.36 || true
          cargo update time-core --precise 0.1.2 || true
          # Pin both getrandom versions that may be present
          cargo update getrandom@0.2 --precise 0.2.15 || true
          cargo update getrandom@0.3 --precise 0.3.1 || true
          
          cd ../ft_mock
          cargo generate-lockfile
          cargo update getrandom@0.2 --precise 0.2.15 || true
          cargo update getrandom@0.3 --precise 0.3.1 || true
          
          cd ../integration-tests
          cargo generate-lockfile
          cargo update getrandom@0.2 --precise 0.2.15 || true
          cargo update getrandom@0.3 --precise 0.3.1 || true

      - name: Build WASM (release)
        working-directory: contracts/near_splitter
        run: cargo build --target wasm32-unknown-unknown --release

      - name: Build FT Mock WASM (release)
        working-directory: contracts/ft_mock
        run: cargo build --target wasm32-unknown-unknown --release

      - name: Optimize WASM with wasm-opt (main contract)
        working-directory: contracts/near_splitter
        run: |
          wasm-opt -Oz --signext-lowering -o target/wasm32-unknown-unknown/release/near_splitter_optimized.wasm \
            target/wasm32-unknown-unknown/release/near_splitter.wasm

      - name: Optimize FT Mock WASM with wasm-opt
        working-directory: contracts/ft_mock
        run: |
          wasm-opt -Oz --signext-lowering -o target/wasm32-unknown-unknown/release/ft_mock_optimized.wasm \
            target/wasm32-unknown-unknown/release/ft_mock.wasm
          # Replace original with optimized version so integration tests use it
          cp target/wasm32-unknown-unknown/release/ft_mock_optimized.wasm \
            target/wasm32-unknown-unknown/release/ft_mock.wasm

      - name: Run unit tests (near_splitter)
        working-directory: contracts/near_splitter
        run: cargo test --lib -- --nocapture

      - name: Run integration tests (sandbox)
        working-directory: contracts/integration-tests
        run: cargo test --test integration -- --nocapture

      - name: Clippy check (lib, no dev-deps)
        working-directory: contracts/near_splitter
        run: cargo clippy --lib --no-deps --target wasm32-unknown-unknown -- -D warnings

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install cargo-audit
        run: cargo install cargo-audit
      - name: Run security audit
        working-directory: contracts/near_splitter
        run: cargo audit
        continue-on-error: true  # Don't fail on advisories, just report
